<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√ºrkiye ƒ∞≈ü Kazalarƒ± Haritasƒ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        #header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        #header .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        #fileUpload {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #5568d3;
        }

        #fileName {
            font-size: 13px;
            color: #666;
            font-style: italic;
            flex: 1;
            min-width: 150px;
        }

        #downloadTemplate {
            padding: 8px 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        #downloadTemplate:hover {
            background: #229954;
        }

        #refreshData {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }

        #refreshData:hover {
            background: #2980b9;
        }

        #controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        input[type="text"], input[type="date"], select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="text"] {
            width: 250px;
        }

        button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: auto;
        }

        button:hover {
            background: #5568d3;
        }

        button.reset {
            background: #e74c3c;
        }

        button.reset:hover {
            background: #c0392b;
        }

        #map {
            flex: 1;
            width: 100%;
            min-height: 500px;
            position: relative;
            background-color: #e8e8e8;
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #stats-section {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-left: 2px solid #e0e0e0;
            overflow-y: auto;
        }

        #stats-header {
            background: white;
            padding: 12px 15px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        #infographic-side {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .info-cards-side {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-card-side {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-card-side .icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .info-card-side .content {
            flex: 1;
            margin-left: 15px;
        }

        .info-card-side .label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-card-side .value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .chart-container-side {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-title-side {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .chart-label {
            min-width: 120px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .chart-bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .chart-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .chart-value {
            min-width: 40px;
            text-align: right;
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .popup-content {
            padding: 5px;
            min-width: 280px;
        }

        .popup-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .popup-item {
            margin-bottom: 10px;
            line-height: 1.6;
            font-size: 13px;
        }

        .popup-label {
            font-weight: 600;
            color: #555;
            display: inline-block;
            margin-right: 5px;
        }

        .popup-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .popup-link:hover {
            transform: translateY(-2px);
        }

        .marker-cluster {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid white;
        }

        .marker-cluster div {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            color: white;
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 1024px) {
            #stats-section {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            #main-container {
                flex-direction: column;
            }

            #stats-section {
                width: 100%;
                max-height: 300px;
            }

            #controls {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="text"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è T√ºrkiye ƒ∞≈ü Kazalarƒ± Haritasƒ±</h1>
        <div class="subtitle">Google Sheets Entegrasyonlu Versiyon</div>
    </div>

    <div id="fileUpload">
        <div class="file-input-wrapper">
            <input type="file" id="csvFile" accept=".csv">
            <label for="csvFile" class="file-input-label">üìÅ CSV Dosyasƒ± Se√ß</label>
        </div>
        <span id="fileName">CSV se√ßilmedi</span>
        <button id="refreshData">üîÑ Google Sheets'ten Yenile</button>
        <a id="downloadTemplate" download="ornek_veri.csv">üì• √ñrnek ≈ûablon ƒ∞ndir</a>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <div id="controls">
        <div class="control-group">
            <label>üîç Ara</label>
            <input type="text" id="searchBox" placeholder="ƒ∞sim, yer veya neden ara...">
        </div>
        
        <div class="control-group">
            <label>üìÖ Ba≈ülangƒ±√ß</label>
            <input type="date" id="startDate">
        </div>

        <div class="control-group">
            <label>üìÖ Biti≈ü</label>
            <input type="date" id="endDate">
        </div>

        <div class="control-group">
            <label>üèôÔ∏è ƒ∞l√ße</label>
            <select id="cityFilter">
                <option value="">T√ºm ƒ∞l√ßeler</option>
            </select>
        </div>

        <button onclick="applyFilters()">Filtrele</button>
        <button class="reset" onclick="resetFilters()">Temizle</button>
    </div>

    <div id="main-container">
        <div id="map-section">
            <div id="map"></div>
        </div>
        
        <div id="stats-section">
            <div id="stats-header">
                <div class="stat-item">
                    <div class="stat-label">Toplam</div>
                    <div class="stat-value" id="totalRecords">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">G√∂sterilen</div>
                    <div class="stat-value" id="displayedRecords">0</div>
                </div>
            </div>

            <div id="infographic-side">
                <div class="info-cards-side">
                    <div class="info-card-side">
                        <div class="icon">üèÜ</div>
                        <div class="content">
                            <div class="label">En √áok Kaza</div>
                            <div class="value" id="topCity">-</div>
                        </div>
                    </div>

                    <div class="info-card-side">
                        <div class="icon">‚ö†Ô∏è</div>
                        <div class="content">
                            <div class="label">En Yaygƒ±n Neden</div>
                            <div class="value" id="topReason">-</div>
                        </div>
                    </div>

                    <div class="info-card-side">
                        <div class="icon">üè≠</div>
                        <div class="content">
                            <div class="label">En Riskli Sekt√∂r</div>
                            <div class="value" id="topSector">-</div>
                        </div>
                    </div>

                    <div class="info-card-side">
                        <div class="icon">üìÖ</div>
                        <div class="content">
                            <div class="label">En Yoƒüun Ay</div>
                            <div class="value" id="topMonth">-</div>
                        </div>
                    </div>

                    <div class="info-card-side">
                        <div class="icon">üìç</div>
                        <div class="content">
                            <div class="label">Etkilenen B√∂lge</div>
                            <div class="value" id="cityCount">-</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container-side">
                    <div class="chart-title-side">üìä ƒ∞l√ßelere G√∂re Daƒüƒ±lƒ±m</div>
                    <div id="cityChart"></div>
                </div>

                <div class="chart-container-side">
                    <div class="chart-title-side">üè≠ Sekt√∂rlere G√∂re Daƒüƒ±lƒ±m</div>
                    <div id="sectorChart"></div>
                </div>

                <div class="chart-container-side">
                    <div class="chart-title-side">‚ö†Ô∏è Nedenlere G√∂re Daƒüƒ±lƒ±m</div>
                    <div id="reasonChart"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Veriler y√ºkleniyor...</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // GOOGLE SHEETS AYARLARI
        // Buraya kendi Google Sheets ID'nizi ekleyin
        const GOOGLE_SHEETS_ID = '1sfXYZs5njG2jahHcJSzKDbvNosQFjRso2cZNZ872LjE';
        const SHEET_NAME = 'Form Yanƒ±tlarƒ± 1'; // Sayfa adƒ±nƒ±zƒ± buraya yazƒ±n
        
        // Harita ba≈ülat
        const map = L.map('map').setView([40.75, 30.40], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            maxClusterRadius: 50
        });

        let dataSet = [];
        let allMarkers = [];

        // Google Sheets'ten veri y√ºkle
        async function loadFromGoogleSheets() {
            if (GOOGLE_SHEETS_ID === '1sfXYZs5njG2jahHcJSzKDbvNosQFjRso2cZNZ872LjE') {
                showError('‚ö†Ô∏è L√ºtfen √∂nce Google Sheets ID\'nizi kodda g√ºncelleyin!');
                return;
            }

            showLoading(true);
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Google Sheets\'e eri≈üilemedi. L√ºtfen payla≈üƒ±m ayarlarƒ±nƒ± kontrol edin.');
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                        showError('');
                        showLoading(false);
                    },
                    error: function(error) {
                        showError('Veri i≈ülenirken hata: ' + error.message);
                        showLoading(false);
                    }
                });
            } catch (error) {
                showError('‚ùå ' + error.message);
                showLoading(false);
            }
        }

        // √ñrnek CSV ≈üablonu olu≈ütur
        const sampleCSV = `tarih,isim,yer,lat,lon,neden,sektor,link
2024-01-15,Ali Yƒ±lmaz,"Adapazarƒ±, Sakarya",40.7569,30.4013,Y√ºksekten d√º≈üme,ƒ∞n≈üaat,https://www.haberler.com
2024-02-20,Mehmet Demir,"Arifiye, Sakarya",40.7089,30.3658,Makine kazasƒ±,ƒ∞malat,
2024-03-10,Ay≈üe Kaya,"Erenler, Sakarya",40.7333,30.3833,Elektrik √ßarpmasƒ±,Elektrik,`;

        const blob = new Blob([sampleCSV], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        document.getElementById('downloadTemplate').href = url;

        // CSV dosya y√ºkle
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                showLoading(true);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                        showLoading(false);
                    },
                    error: function(error) {
                        showError('CSV dosyasƒ± i≈ülenirken hata: ' + error.message);
                        showLoading(false);
                    }
                });
            }
        });

        // Veriyi i≈üle
        function processData(data) {
            dataSet = data.filter(item => item.lat && item.lon);
            
            // ƒ∞l√ße filtresini doldur
            const districts = [...new Set(dataSet.map(item => {
                const parts = item.yer.split(',');
                return parts.length > 1 ? parts[1].trim() : parts[0].trim();
            }))].sort();

            const cityFilter = document.getElementById('cityFilter');
            cityFilter.innerHTML = '<option value="">T√ºm ƒ∞l√ßeler</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                cityFilter.appendChild(option);
            });

            createMarkers(dataSet);
        }

        // Harita √ºzerinde marker'larƒ± olu≈ütur
        function createMarkers(data) {
            // √ñnceki marker'larƒ± temizle
            markers.clearLayers();
            allMarkers = [];

            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            data.forEach(item => {
                const marker = L.marker([parseFloat(item.lat), parseFloat(item.lon)], {icon: redIcon});
                
                const popupContent = `
                    <div class="popup-content">
                        <div class="popup-title">${item.isim}</div>
                        <div class="popup-item">
                            <span class="popup-label">üìÖ Tarih:</span> ${formatDate(item.tarih)}
                        </div>
                        <div class="popup-item">
                            <span class="popup-label">üìç Yer:</span> ${item.yer}
                        </div>
                        <div class="popup-item">
                            <span class="popup-label">üè≠ Sekt√∂r:</span> ${item.sektor || 'Belirtilmemi≈ü'}
                        </div>
                        <div class="popup-item">
                            <span class="popup-label">‚ö†Ô∏è Neden:</span> ${item.neden}
                        </div>
                        ${item.link ? `<a href="${item.link}" target="_blank" class="popup-link">üîó Haberi Oku</a>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.data = item;
                allMarkers.push(marker);
                markers.addLayer(marker);
            });

            map.addLayer(markers);
            
            if (data.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1), {
                    maxZoom: 10,
                    animate: true,
                    duration: 1.0
                });
            }
            
            updateStats(data.length);
        }

        // Tarih formatlama
        function formatDate(dateString) {
            if (!dateString) return 'Bilinmiyor';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // ƒ∞statistikleri g√ºncelle
        function updateStats(displayed) {
            document.getElementById('totalRecords').textContent = dataSet.length;
            document.getElementById('displayedRecords').textContent = displayed;
            
            if (displayed > 0) {
                generateInfographic(dataSet.filter((item, index) => {
                    const searchText = document.getElementById('searchBox').value.toLowerCase();
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    const district = document.getElementById('cityFilter').value;

                    const matchSearch = !searchText || 
                        item.isim.toLowerCase().includes(searchText) ||
                        item.yer.toLowerCase().includes(searchText) ||
                        item.neden.toLowerCase().includes(searchText);

                    const matchStartDate = !startDate || item.tarih >= startDate;
                    const matchEndDate = !endDate || item.tarih <= endDate;
                    
                    const itemDistrict = item.yer.split(',').length > 1 ? 
                        item.yer.split(',')[1].trim() : item.yer.split(',')[0].trim();
                    const matchDistrict = !district || itemDistrict === district;

                    return matchSearch && matchStartDate && matchEndDate && matchDistrict;
                }));
            }
        }

        // ƒ∞nfografik olu≈ütur
        function generateInfographic(data) {
            if (data.length === 0) {
                return;
            }

            // ƒ∞l√ße analizi
            const districtData = {};
            data.forEach(item => {
                const parts = item.yer.split(',');
                const district = parts.length > 1 ? parts[1].trim() : parts[0].trim();
                districtData[district] = (districtData[district] || 0) + 1;
            });

            const topDistricts = Object.entries(districtData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Sekt√∂r analizi
            const sectorData = {};
            data.forEach(item => {
                const sector = item.sektor || 'Diƒüer';
                sectorData[sector] = (sectorData[sector] || 0) + 1;
            });

            const topSectors = Object.entries(sectorData)
                .sort((a, b) => b[1] - a[1]);

            // Neden analizi
            const reasonData = {};
            data.forEach(item => {
                const reason = item.neden.substring(0, 30);
                reasonData[reason] = (reasonData[reason] || 0) + 1;
            });

            const topReasons = Object.entries(reasonData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Ay analizi
            const monthData = {};
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                              'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            data.forEach(item => {
                if (item.tarih) {
                    const month = new Date(item.tarih).getMonth();
                    const monthName = monthNames[month];
                    monthData[monthName] = (monthData[monthName] || 0) + 1;
                }
            });

            const topMonth = Object.entries(monthData)
                .sort((a, b) => b[1] - a[1])[0];

            // Kartlarƒ± g√ºncelle
            document.getElementById('topCity').textContent = 
                topDistricts[0] ? `${topDistricts[0][0]} (${topDistricts[0][1]})` : '-';
            document.getElementById('topReason').textContent = 
                topReasons[0] ? `${topReasons[0][0]}... (${topReasons[0][1]})` : '-';
            document.getElementById('topSector').textContent = 
                topSectors[0] ? `${topSectors[0][0]} (${topSectors[0][1]})` : '-';
            document.getElementById('topMonth').textContent = 
                topMonth ? `${topMonth[0]} (${topMonth[1]})` : '-';
            document.getElementById('cityCount').textContent = 
                `${Object.keys(districtData).length} ƒ∞l√ße`;

            // Grafikleri g√ºncelle
            updateChart('cityChart', topDistricts);
            updateChart('sectorChart', topSectors);
            updateChart('reasonChart', topReasons);
        }

        // Grafik g√ºncelle
        function updateChart(chartId, data) {
            const maxValue = data[0] ? data[0][1] : 1;
            let chartHTML = '';
            data.forEach(([label, count]) => {
                const percentage = (count / maxValue) * 100;
                chartHTML += `
                    <div class="chart-item">
                        <div class="chart-label">${label}</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${count}</div>
                    </div>
                `;
            });
            document.getElementById(chartId).innerHTML = chartHTML;
        }

        // Filtreleri uygula
        function applyFilters() {
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const district = document.getElementById('cityFilter').value;

            const filtered = dataSet.filter(item => {
                const matchSearch = !searchText || 
                    item.isim.toLowerCase().includes(searchText) ||
                    item.yer.toLowerCase().includes(searchText) ||
                    item.neden.toLowerCase().includes(searchText);

                const matchStartDate = !startDate || item.tarih >= startDate;
                const matchEndDate = !endDate || item.tarih <= endDate;

                const itemDistrict = item.yer.split(',').length > 1 ? 
                    item.yer.split(',')[1].trim() : item.yer.split(',')[0].trim();
                const matchDistrict = !district || itemDistrict === district;

                return matchSearch && matchStartDate && matchEndDate && matchDistrict;
            });

            createMarkers(filtered);
        }

        // Filtreleri sƒ±fƒ±rla
        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('cityFilter').value = '';
            createMarkers(dataSet);
        }

        // Y√ºkleme ekranƒ± g√∂ster/gizle
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        // Hata mesajƒ± g√∂ster
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.toggle('show', message !== '');
        }

        // Google Sheets'ten yenile butonu
        document.getElementById('refreshData').addEventListener('click', loadFromGoogleSheets);

        // Arama kutusunda her tu≈üta filtrele
        document.getElementById('searchBox').addEventListener('input', applyFilters);

        // Sayfa y√ºklendiƒüinde
        updateStats(0);
    </script>
</body>
</html>
